package com.foomap.activity;


import java.util.ArrayList;
import java.util.HashMap;

import android.app.Activity;
import android.content.Context;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;

import com.baidu.location.BDLocation;
import com.baidu.location.BDLocationListener;
import com.baidu.mapapi.SDKInitializer;
import com.baidu.mapapi.map.BaiduMap;
import com.baidu.mapapi.map.BitmapDescriptor;
import com.baidu.mapapi.map.BitmapDescriptorFactory;
import com.baidu.mapapi.map.MapStatusUpdateFactory;
import com.baidu.mapapi.map.MapView;
import com.baidu.mapapi.map.MarkerOptions;
import com.baidu.mapapi.map.OverlayOptions;
import com.baidu.mapapi.model.LatLng;
import com.foodmap.R;
import com.foomap.model.CollectionData;
import com.foomap.model.ShopData;
import com.foomap.service.CollectionHttpService;
import com.foomap.service.CommentHttpService;
import com.foomap.service.CommentHttpService.ICommentAdapter;
import com.foomap.service.HttpServiceHelper.IOnHttpRequeseListener;
import com.foomap.service.LocationSever;
import com.foomap.service.UserHttpService;
import com.foomap.util.CollectionJsonUtils;

public class MapViewActivity extends Activity {
	
	private static String TAG="MapViewActivity";
	private MapView mapView;
	private BaiduMap map;
	private Context context;
	private Handler handler;
	private LocationSever lc;
	private Button bt;
	//商家信息
	ArrayList<ShopData> shopDatas;
	

	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		// 百度SDK初始化
		SDKInitializer.initialize(getApplicationContext());
		setContentView(R.layout.mapview_activity);
		this.context=this;
		init();

	}

	@Override
	protected void onDestroy() {
		// TODO Auto-generated method stub
		super.onDestroy();
		mapView.onDestroy();
	}

	@Override
	protected void onPause() {
		// TODO Auto-generated method stub
		super.onPause();
		mapView.onPause();
	}

	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();
		mapView.onResume();
		
		
	}

	// ===============================================================
	protected void init() {
		mapView = (MapView) findViewById(R.id.bmapView_mapView);
		bt=(Button)findViewById(R.id.refrshMap_main);
		shopDatas=(ArrayList<ShopData>) getIntent().getExtras().getSerializable("shopData");
		map = mapView.getMap();
		lc=new LocationSever(getApplicationContext());

		// 遮挡物
		map.setMapType(BaiduMap.MAP_TYPE_NORMAL);
		lc.requestLocation(new BDLocationListener() {
			
			@Override
			public void onReceiveLocation(BDLocation loction) {
				// TODO Auto-generated method stub
				if(loction!=null)
				{
					LatLng tmp=new LatLng(loction.getLatitude(), loction.getLongitude());
					setMapViewCenter(tmp);
					lc.stop();
					addOverLayOption(shopDatas);
				}
				
				
			}
		});   
	
		
		
	}
	public void setMapViewCenter(LatLng latLng)
	{
	   map.setMapStatus(MapStatusUpdateFactory.newLatLngZoom(latLng, 17));
	
	   BitmapDescriptor bitmap=BitmapDescriptorFactory.fromResource(R.drawable.ic_launcher);
		OverlayOptions option=new MarkerOptions().position(latLng).icon(bitmap);
		map.addOverlay(option);
	   
	}
	


	public void addOverLayOption(ArrayList<ShopData> list) {
		for (ShopData item : list) {
			BitmapDescriptor bitmap=BitmapDescriptorFactory.fromResource(R.drawable.sr_map_common);
			LatLng itemLatLng=new LatLng(item.getLatitude(), item.getLongitude());
			OverlayOptions option=new MarkerOptions().position(itemLatLng).icon(bitmap);
			map.addOverlay(option);
              
		}
	}



	

}
