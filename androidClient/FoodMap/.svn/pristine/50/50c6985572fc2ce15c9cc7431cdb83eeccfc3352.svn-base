package com.foomap.activity;

import java.util.ArrayList;

import org.json.JSONException;
import org.json.JSONObject;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.support.v4.view.PagerAdapter;
import android.support.v4.view.ViewPager;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.ImageView;

import com.foodmap.R;
import com.foomap.model.ShopData;
import com.foomap.service.HttpServiceHelper.IOnHttpRequeseListener;
import com.foomap.service.ShophttpService;
import com.foomap.util.ImageManager;







import com.foomap.util.ShopJsonUtils;

import fview.PoiCommentView;
import fview.PoiDesCriptionView;


public class PoiDetailActivity extends Activity implements OnClickListener{ 
	private static String TAG="PoiDetailActivity";
	
	
	private Context context;
	private ViewPager viewPager;
	
	private int shopId;
	private ShophttpService shophttpService;
	private ImageView poiPicMain;
	//
	private ShopData shopData;
	//viewPager内容
	private ArrayList<View> viewList;
	private PoiCommentView commentView;
	private PoiDesCriptionView desCriptionView;
	//评论收藏
	private Button comment,collection;
	
	
	

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		super.onCreate(savedInstanceState);
		setContentView(R.layout.poidetail);
		context=this;
		
		init();
	}                    
	protected void init()
	{
		shophttpService=new ShophttpService();
		collection=(Button)findViewById(R.id.collection_bt_poiDetail);
		comment=(Button)findViewById(R.id.comment_bt_poiDetail);
		viewPager=(ViewPager)findViewById(R.id.viewpager_poidetail);
		desCriptionView=new PoiDesCriptionView(context);
		bindEvent();
		//viewPage内容填充
		commentView=new PoiCommentView(context);
		viewList=new ArrayList<View>();
		viewList.add(desCriptionView);
		viewList.add(commentView);
		viewPager.setAdapter(new MPagerAdapter());
		poiPicMain=(ImageView)findViewById(R.id.poiPicMain_poiDetail);
		//填充商户信息
		
		shopId=getIntent().getExtras().getInt("shopId");
		shophttpService.searchById(shopId, new IOnHttpRequeseListener() {
			
			@Override
			public void finished(String jsonRes) {
				// TODO Auto-generated method stub
				Log.i(TAG, jsonRes);
				
				try {
					JSONObject shopJsonObject = new JSONObject(jsonRes).getJSONObject("info");
					shopData=ShopJsonUtils.getShopData(shopJsonObject);
					ImageManager.Load(shopData.iconUrl, poiPicMain,ImageManager.options);
					desCriptionView.refresh(shopData);
					commentView.refreash(shopId);
				} catch (JSONException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				
			}
		});
		
		
		
		
		
	    
	    
	}
	public void bindEvent()
	{
		comment.setOnClickListener(this);
		collection.setOnClickListener(this);
	}


	protected class MPagerAdapter extends PagerAdapter
	{

		@Override
		public int getCount() {
			// TODO Auto-generated method stub
			return viewList.size();
		}

		@Override
		public boolean isViewFromObject(View arg0, Object arg1) {
			// TODO Auto-generated method stub
			return arg0==arg1;
		}

	

		@Override
		public void destroyItem(ViewGroup container, int position, Object object) {
			// TODO Auto-generated method stub
			container.removeView(viewList.get(position));
		}

		@Override
		public Object instantiateItem(ViewGroup container, int position) {
			// TODO Auto-generated method stub
			container.addView(viewList.get(position));
			return viewList.get(position);
		}
		
		
	}
	@Override
	public void onClick(View v) {
		// TODO Auto-generated method stub
		if(v==collection)
		{
			//收藏
		}
		else if(v==comment)
		{
			Intent intent=new Intent();
			intent.putExtra("shopId", shopData.id);
			intent.setClass(context, CommentActivity.class);
			startActivity(intent);
		}
		
	}
	
}
